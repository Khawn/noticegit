<!DOCTYPE html>
<!-- saved from url=(0043)http://mysql.taobao.org/monthly/2019/10/01/ -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>MySQL · 引擎特性 · Innodb 表空间</title>
  <meta name="description" content="概述">

  <link rel="stylesheet" href="./MySQL · 引擎特性 · Innodb 表空间_files/typo.css">
  <link rel="stylesheet" href="./MySQL · 引擎特性 · Innodb 表空间_files/animate.css">
  <link rel="stylesheet" href="./MySQL · 引擎特性 · Innodb 表空间_files/main.css">
  <link rel="canonical" href="http://100.82.131.198:4000/monthly/2019/10/01/">
  <link rel="alternate" type="application/rss+xml" title="数据库内核月报" href="http://100.82.131.198:4000/monthly/feed.xml">

  <link rel="stylesheet" href="./MySQL · 引擎特性 · Innodb 表空间_files/tomorrow.min.css">
  <script async="" src="./MySQL · 引擎特性 · Innodb 表空间_files/analytics.js"></script><script src="./MySQL · 引擎特性 · Innodb 表空间_files/highlight.min.js"></script>
  <!-- <link rel="stylesheet" href="/monthly/themes/tomorrow.css">
  <script src="/monthly/highlight/highlight.pack.js"> -->
  <script>hljs.initHighlightingOnLoad();</script>

  <script src="./MySQL · 引擎特性 · Innodb 表空间_files/jquery.min.js"></script>
  <script src="./MySQL · 引擎特性 · Innodb 表空间_files/jquery.min.map"></script>

  <script src="./MySQL · 引擎特性 · Innodb 表空间_files/changeTarget.js"></script>
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-62056244-1', 'auto');
  ga('send', 'pageview');
</script></head>


<!-- Google Analysis -->



  <body>

    <header>

  <a id="go-back-home" href="http://mysql.taobao.org/monthly/2019/10">
    <h1>数据库内核月报 － 2019 / 10</h1>
  </a>

</header>


        <section class="paging">
  
  
  

  
    
  
  
    
      <div class="right">
        <a href="http://mysql.taobao.org/monthly/2019/10/02/">
          ›
        </a>
      </div>
    
  
</section>


<div id="container" class="animated zoomIn">
  <div class="block">
  <nav id="primary_nav_wrap">
<ul>
  <li><a href="http://mysql.taobao.org/monthly/2019/10/01/#">当期文章</a>
    <ul class="animated">
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
            
              <li class="current-menu-item">
            
              <a href="http://mysql.taobao.org/monthly/2019/10/01/" target="_blank">
                
                MySQL · 引擎特性 · Innodb 表空间
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="http://mysql.taobao.org/monthly/2019/10/02/" target="_blank">
                
                MySQL · 引擎特性 · POLARDB 并行查询加速全程详解
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="http://mysql.taobao.org/monthly/2019/10/03/" target="_blank">
                
                MySQL · Optimizer · Parallel Index Scans, One is Better Than Two
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="http://mysql.taobao.org/monthly/2019/10/04/" target="_blank">
                
                MySQL · 最佳实践 · X-Engine MySQL RDS 用户的新选择
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="http://mysql.taobao.org/monthly/2019/10/05/" target="_blank">
                
                MySQL · 引擎特性 · Sequence Engine
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="http://mysql.taobao.org/monthly/2019/10/06/" target="_blank">
                
                PgSQL · 应用案例 · 分组提交的使用与注意
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="http://mysql.taobao.org/monthly/2019/10/07/" target="_blank">
                
                MongoDB · 最佳实践 · Spark Connector 实战指南
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="http://mysql.taobao.org/monthly/2019/10/08/" target="_blank">
                
                PgSQL · 应用案例 · PG 12 tpcc - use sysbench-tpcc by Percona-Lab
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="http://mysql.taobao.org/monthly/2019/10/09/" target="_blank">
                
                PgSQL · 应用案例 ·  阿里云RDS PG 11开放dblink, postgres_fdw权限
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="http://mysql.taobao.org/monthly/2019/10/10/" target="_blank">
                
                PgSQL · 应用案例 · Oracle 20c 新特性 - 翻出了PG十年前的特性
              </a>
            </li>
          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
    </ul>
  </li>
</ul>
</nav>

    <div class="title">
      <h2>
        
        MySQL · 引擎特性 · Innodb 表空间
      </h2>
    </div>
  </div>
  <div class="content typo">
    <section class="post">
      <h4>概述</h4>

<p>除redo日志文件外，InnoDB的物理文件基本上具有相当统一的结构：固定大小页面，使用B-tree来管理。默认情况下，每个页面为16KB，也可以自定义配置该数值。对于压缩表，可以在建表时指定页大小，但在内存中表现的解压页依旧为统一的页大小。</p>

<p>从物理文件的分类来看，有日志文件、主系统表空间文件ibdata、undo tablespace文件、临时表空间文件、用户表空间。我们这里主要关心存储用户数据的用户表空间的物理文件结构。</p>

<p>用户表空间，顾名思义，就是用户创建的表空间，如果开启独立表空间参数，那么一个表空间会对应磁盘上的一个物理文件。</p>

<h4>segment、extent和page</h4>

<p>从外部来看，表空间是由连续的固定大小page构成。其实表空间文件内部还是组织为更复杂的逻辑结构，自顶向下可分为segment、extent和page。</p>

<p>表空间下一级称为segment。segment与数据库中的索引相映射。Innodb引擎内，每个索引对应两个segment：管理叶子节点的segment和管理非叶子节点segment。创建索引中很关键的步骤便是分配segment，Innodb内部使用INODE来描述segment。</p>

<p>segment的下一级是extent，extent代表一组连续的page，默认为64个page，大小1MB。extent的作用是提高page分配效率，批量分配在效率上总是优于离散、单一的page分配，另外在数据连续性方面也更佳，segment扩容时以extent为单位分配。Innodb内部使用XDES来描述extent。</p>

<p>page则是表空间数据存储的基本单位，innodb将表文件（xxx.ibd）按page切分，依类型不同，page内容也有所区别，最为常见的是存储数据库表的行记录。page格式会在后续文章中进行比较详细的剖析，本文中主要介绍一些特殊的存储表空间元信息的page。</p>

<h4>表空间关键page</h4>

<p>每个独立表空间都对应磁盘上的一个物理文件，命名形式为{table_name}.ibd。物理文件按page切分，这些page主要分为两类：存储表空间元信息的page和存储表空间用户数据的page。存储用户数据的page暂不关心，这里主要讨论表空间元信息page。</p>

<p>如下图，表空间的前三个page为主要的元信息page。</p>

<p><img src="./MySQL · 引擎特性 · Innodb 表空间_files/ibd_file_overview.png" alt=""></p>

<p><strong>FSP HEADER PAGE</strong></p>

<p>FSP header page是表空间的root page，存储表空间关键元数据信息。由page file header、fsp header、xdes entries三大部分构成。完整格式如下图：</p>

<p><img src="./MySQL · 引擎特性 · Innodb 表空间_files/ibd_header_page.png" alt=""></p>

<p>root page也存在38字节头部信息。其中几个关键字段：</p>

<blockquote>
  <ul>
    <li>
      <p><strong>FIL_PAGE_ARCH_LOG_NO_OR_SPACE_ID</strong>：存储表空间的space id</p>
    </li>
    <li>
      <p><strong>FIL_PAGE_SRV_VERSION</strong>：本来被用于存储前一个页面id，在root page中被用来存储SERVER版本号</p>
    </li>
    <li>
      <p><strong>FIL_PAGE_SPACE_VERSION</strong>：本来被用于存储后一个页面id，在root page中被用来存储TABLE SPACE版本号</p>
    </li>
  </ul>
</blockquote>

<p>fsp header主要存储表空间元信息，维护关键结构分配链表，主要成员有：</p>

<blockquote>
  <ul>
    <li><strong>FSP_SIZE</strong>：表空间大小，以Page数量计算</li>
    <li><strong>FSP_FREE_LIMIT</strong>：目前在空闲的<code>Extent</code>上最小的尚未被初始化的<code>Page</code>的`Page Number</li>
    <li><strong>FSP_FREE</strong>：空闲extent链表，链表中的每一项为代表extent的xdes，所谓空闲extent是指该extent内所有page均未被使用</li>
    <li><strong>FSP_FREE_FRAG</strong>：free frag extent链表，链表中的每一项为代表extent的xdes，所谓free frag extent是指该extent内有部分page未被使用</li>
    <li><strong>FSP_FULL_FRAG</strong>：full frag extent链表，链表中的每一项为代表extent的xdes，所谓full frag extent是指该extent内所有Page均已被使用</li>
    <li><strong>FSP_SEG_ID</strong>：下次待分配的segment id，每次分配新segment时均会使用该字段作为segment id，并将该字段值+1写回</li>
    <li><strong>FSP_SEG_INODES_FULL</strong>：full inode page链表，链表中的每一项为inode page，该链表中的每个inode page内的inode entry都已经被使用</li>
    <li><strong>FSP_SEG_INODES_FREE</strong>：free inode page链表，链表中的每一项为inode page，该链表中的每个inode page内上有空闲inode entry可分配</li>
  </ul>
</blockquote>

<p>上面提到了各种链表，这些链表其实是磁盘上的同类对象连接形成，可加速对象分配和管理。后文会描述其实现细节。需要注意的是，root page中存在两类链表：第一是链接描述extent的xdes，第二是链接inode page。</p>

<p>第三部分是描述extent的xdes（extent descriptor）信息，每个xdes page中均存储256个xdes，描述接下来连续的256个extent（16384个page）。</p>

<p><img src="./MySQL · 引擎特性 · Innodb 表空间_files/ibd_header_xdes_arr.png" alt="">每个XDES项占据40字节，因此，一个xdes page可跟踪其后的256个extent的分配情况，XDES结构如下：</p>

<p><img src="./MySQL · 引擎特性 · Innodb 表空间_files/ibd_xdes.png" alt=""></p>

<p>由于单个xdes page只能描述256个extent，因此，每隔256个extent（16384个page）便需要一个xdes page。</p>

<p><strong>IBUF BITMAP PAGE</strong></p>

<p>作用暂时未知</p>

<p><strong>INODE PAGE</strong></p>

<p>表空间文件的第3个page的类型为<em>FIL_PAGE_INODE</em>，存储inode（index node），管理表空间的segment。每个inode对应一个segment。每个inode page默认存储FSP_SEG_INODES_PER_PAGE（85）个inode。每个索引使用2个segment，分别用于管理叶子节点和非叶子节点。</p>

<p>inode page由page header和inode entry组成，page header为38字节。inode为192字节。</p>

<table>
  <thead>
    <tr>
      <th>Macro</th>
      <th>bits</th>
      <th>Desc</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>FSEG_INODE_PAGE_NODE</td>
      <td>12</td>
      <td>INODE page在fsp header的某个链表节点，记录前后inode page的位置。该链表为header page的FSP_SEG_INODES_FULL或FSP_SEG_INODES_FREE。</td>
    </tr>
    <tr>
      <td>Inode Entry 0</td>
      <td>192</td>
      <td>inode entry</td>
    </tr>
    <tr>
      <td>Inode Entry 1</td>
      <td>192</td>
      <td>inode entry</td>
    </tr>
    <tr>
      <td>……</td>
      <td>…</td>
      <td>&nbsp;</td>
    </tr>
    <tr>
      <td>Inode Entry 84</td>
      <td>192</td>
      <td>inode entry</td>
    </tr>
  </tbody>
</table>

<p>Inode Entry的结构如下表：</p>

<table>
  <thead>
    <tr>
      <th>Macro</th>
      <th>bits</th>
      <th>Desc</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>FSEG_ID</td>
      <td>8</td>
      <td>该inode代表的Segment ID，若值为0表示该slot未被使用</td>
    </tr>
    <tr>
      <td>FSEG_NOT_FULL_N_USED</td>
      <td>8</td>
      <td>FSEG_NOT_FULL链表上被使用的Page数量</td>
    </tr>
    <tr>
      <td>FSEG_FREE</td>
      <td>16</td>
      <td>segment上所有page均空闲的extent链表</td>
    </tr>
    <tr>
      <td>FSEG_NOT_FULL</td>
      <td>16</td>
      <td>至少有一个page分配给当前Segment的Extent链表，全部用完时，转移到FSEG_FULL上，全部释放时，则归还给当前表空间FSP_FREE链表</td>
    </tr>
    <tr>
      <td>FSEG_FULL</td>
      <td>16</td>
      <td>segment上page被完全使用的extent链表</td>
    </tr>
    <tr>
      <td>FSEG_MAGIC_N</td>
      <td>4</td>
      <td>Magic Number</td>
    </tr>
    <tr>
      <td>FSEG_FRAG_ARR 0</td>
      <td>4</td>
      <td>属于该Segment的frag page。总是先从全局分配独立的Page，当填满32个数组项时，就在每次分配时都分配一个完整的Extent，并在XDES PAGE中将其Segment ID设置为当前值</td>
    </tr>
    <tr>
      <td>……</td>
      <td>……</td>
      <td>&nbsp;</td>
    </tr>
    <tr>
      <td>FSEG_FRAG_ARR 31</td>
      <td>4</td>
      <td>Segment的第32个Frag Page</td>
    </tr>
  </tbody>
</table>

<p>inode中最关键的也是各种extent链表，以加速segment中page分配。分配时，优先从空闲extent链表中分配，当无可用extent时，会向表空间中申请若干可用extent加入自身的空闲extent链表。另外，每个segment还有若干（32）碎片page，当segment初始扩容时，首先分配这些碎片page，直到分配完毕才会进入extent分配。</p>

<p><img src="./MySQL · 引擎特性 · Innodb 表空间_files/ibd_inode_page.png" alt=""></p>

<p><img src="./MySQL · 引擎特性 · Innodb 表空间_files/ibd_inode_page.png" alt=""></p>

<h4>关键流程</h4>

<p><strong>创建表空间</strong></p>

<p>创建表空间最终落实到函数<em>fil_create_tablespace</em>，创建ibd文件并初始化fsp header：</p>

<pre><code class="language-c++ hljs cpp"><span class="hljs-function">dberr_t <span class="hljs-title">dict_build_tablespace</span><span class="hljs-params">(trx_t *trx, Tablespace *tablespace)</span> </span>{
  ...
  err = fil_ibd_create(space, tablespace-&gt;name(), datafile-&gt;filepath(),
                       tablespace-&gt;flags(), FIL_IBD_FILE_INITIAL_SIZE);
  ...
  <span class="hljs-comment">// 初始化fsp header的其他字段</span>
  <span class="hljs-keyword">bool</span> ret = fsp_header_init(space, FIL_IBD_FILE_INITIAL_SIZE, &amp;mtr, <span class="hljs-keyword">false</span>);
  ...
}

<span class="hljs-function"><span class="hljs-keyword">static</span> dberr_t <span class="hljs-title">fil_create_tablespace</span><span class="hljs-params">(space_id_t space_id, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *name,
                                     <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path, ulint flags,
                                     page_no_t size, fil_type_t type)</span>
</span>{
	...
    <span class="hljs-comment">// 创建ibd文件</span>
	file = os_file_create(
      	type == FIL_TYPE_TEMPORARY ? innodb_temp_file_key : innodb_data_file_key,
      	path, OS_FILE_CREATE | OS_FILE_ON_ERROR_NO_EXIT, OS_FILE_NORMAL,
      	OS_DATA_FILE, srv_read_only_mode &amp;&amp; (type != FIL_TYPE_TEMPORARY),
      	&amp;success);
    ...
    <span class="hljs-comment">// 这里会将新创建的ibd文件填0以预分配空间</span>
    <span class="hljs-comment">// 调试显示size=7，即分配的空间为7*16KB，但os_file_set_size内会将其向上调整至8*16KB</span>
    <span class="hljs-comment">// buf2 = static_cast&lt;byte *&gt;(ut_malloc_nokey(buf_size + UNIV_PAGE_SIZE));</span>
    success = os_file_set_size(path, file, <span class="hljs-number">0</span>, size * page_size.physical(),
                             srv_read_only_mode, <span class="hljs-keyword">true</span>);
	...
    <span class="hljs-comment">// 初始化fsp header pages，其中前3个page作用比较关键：</span>
    <span class="hljs-comment">// page 0: root page，也是fsp header page</span>
    <span class="hljs-comment">// page 1: ibuf_bitmap page，作用暂时不明</span>
    <span class="hljs-comment">// page 2: inode page，管理segment分配，每个inode entry对应一个segment</span>
    buf2 = <span class="hljs-keyword">static_cast</span>&lt;byte *&gt;(ut_malloc_nokey(<span class="hljs-number">3</span> * page_size.logical()));

  	page = <span class="hljs-keyword">static_cast</span>&lt;byte *&gt;(ut_align(buf2, page_size.logical()));
  	<span class="hljs-built_in">memset</span>(page, <span class="hljs-string">'\0'</span>, page_size.logical());
	
  	flags = fsp_flags_set_page_size(flags, page_size);
  	fsp_header_init_fields(page, space_id, flags);
  	mach_write_to_4(page + FIL_PAGE_ARCH_LOG_NO_OR_SPACE_ID, space_id);

  	mach_write_to_4(page + FIL_PAGE_SRV_VERSION, DD_SPACE_CURRENT_SRV_VERSION);
  	mach_write_to_4(page + FIL_PAGE_SPACE_VERSION, DD_SPACE_CURRENT_SPACE_VERSION);
	...
}
</code></pre>

<h4>创建segment</h4>

<p>innodb的space中，inode、extent和page之间环环相扣，inode对应的是segment，extent
对应的是页簇，page是页。必需先创建segment，然后再从segment内分配extent和page。创建segment核心是从inode page中分配空闲的inode。</p>

<pre><code class="language-c++ hljs cpp">buf_block_t *fseg_create_general(
    space_id_t space_id, 
    page_no_t page,  <span class="hljs-comment">// 调用者多传入0,表示需要分配一个新page作为segment header</span>
    ulint byte_offset,   
    ibool has_done_reservation, 
    mtr_t *mtr)                 
{

  fil_space_t *space = fil_space_get(space_id);

  mtr_x_lock_space(space, mtr);
  <span class="hljs-function"><span class="hljs-keyword">const</span> page_size_t <span class="hljs-title">page_size</span><span class="hljs-params">(space-&gt;flags)</span></span>;
  ...

  space_header = fsp_get_space_header(space_id, page_size, mtr);

  <span class="hljs-comment">// 分配inode entry，代表该segment</span>
  inode = fsp_alloc_seg_inode(space_header, mtr);

  <span class="hljs-comment">// 从table space的page header中读取下一个要使用的segment id</span>
  <span class="hljs-comment">// 将其设置在inode entry的FSEG_ID字段中</span>
  <span class="hljs-comment">// 同时将刚刚已分配的segment id递增1并写回space的page header的FSP_SEG_ID字段</span>
  seg_id = mach_read_from_8(space_header + FSP_SEG_ID);
  mlog_write_ull(space_header + FSP_SEG_ID, seg_id + <span class="hljs-number">1</span>, mtr);
  mlog_write_ull(inode + FSEG_ID, seg_id, mtr);
  mlog_write_ulint(inode + FSEG_NOT_FULL_N_USED, <span class="hljs-number">0</span>, MLOG_4BYTES, mtr);

  <span class="hljs-comment">// 初始化inode中的各种extent链表</span>
  flst_init(inode + FSEG_FREE, mtr);
  flst_init(inode + FSEG_NOT_FULL, mtr);
  flst_init(inode + FSEG_FULL, mtr);

  <span class="hljs-comment">// 初始化segment的frag page数组为空(未分配任何page)</span>
  mlog_write_ulint(inode + FSEG_MAGIC_N, FSEG_MAGIC_N_VALUE, MLOG_4BYTES, mtr);
  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; FSEG_FRAG_ARR_N_SLOTS; i++) {
    fseg_set_nth_frag_page_no(inode, i, FIL_NULL, mtr);
  }

  <span class="hljs-comment">// 且该page的类型是FIL_PAGE_TYPE_SYS</span>
  <span class="hljs-comment">// 该page是Change Buffer的header page，主要用于对ibuf btree的Page管理。</span>
  <span class="hljs-keyword">if</span> (page == <span class="hljs-number">0</span>) {
    block = fseg_alloc_free_page_low(space, page_size, inode, <span class="hljs-number">0</span>, FSP_UP,
                                     RW_SX_LATCH, mtr, mtr);

    header = byte_offset + buf_block_get_frame(block);
    mlog_write_ulint(buf_block_get_frame(block) + FIL_PAGE_TYPE,
                     FIL_PAGE_TYPE_SYS, MLOG_2BYTES, mtr);
  }

  <span class="hljs-comment">// 初始化page header</span>
  mlog_write_ulint(header + FSEG_HDR_OFFSET, page_offset(inode), MLOG_2BYTES,
                   mtr);
  mlog_write_ulint(header + FSEG_HDR_PAGE_NO,
                   page_get_page_no(page_align(inode)), MLOG_4BYTES, mtr);
  mlog_write_ulint(header + FSEG_HDR_SPACE, space_id, MLOG_4BYTES, mtr);
  ...
}

<span class="hljs-keyword">static</span> fseg_inode_t *fsp_alloc_seg_inode(
    fsp_header_t *space_header,
    mtr_t *mtr)
{
  ...
  <span class="hljs-comment">// 如果FSP_SEG_INODES_FREE链表为空</span>
  <span class="hljs-comment">// 该链表用于链接那些尚有inode空间可分配的inode_page</span>
  <span class="hljs-comment">// 如果该链表为空,那就要分配一个新的inode page了,这个过程我们在下面描述</span>
  <span class="hljs-comment">// 调用fsp_alloc_seg_inode_page创建一个新的inode page</span>
  <span class="hljs-keyword">if</span> (flst_get_len(space_header + FSP_SEG_INODES_FREE) == <span class="hljs-number">0</span> &amp;&amp;
      !fsp_alloc_seg_inode_page(space_header, mtr)) {
    <span class="hljs-keyword">return</span> (NULL);
  }
  
  ...
  <span class="hljs-comment">// 从inode page中分配一个空闲inode</span>
  <span class="hljs-function"><span class="hljs-keyword">const</span> page_size_t <span class="hljs-title">page_size</span><span class="hljs-params">(mach_read_from_4(FSP_SPACE_FLAGS + space_header)</span>)</span>;
  <span class="hljs-function"><span class="hljs-keyword">const</span> page_id_t <span class="hljs-title">page_id</span><span class="hljs-params">(
      page_get_space_id(page_align(space_header)</span>),
      <span class="hljs-title">flst_get_first</span><span class="hljs-params">(space_header + FSP_SEG_INODES_FREE, mtr)</span>.page)</span>;

  block = buf_page_get(page_id, page_size, RW_SX_LATCH, mtr);
  page = buf_block_get_frame(block);

  <span class="hljs-comment">// 遍历该inode page的所有inode entry</span>
  <span class="hljs-comment">// 如果发现某个Inode Entry的FSEG_ID字段未设置</span>
  <span class="hljs-comment">// 即认为该inode entry尚未分配</span>
  n = fsp_seg_inode_page_find_free(page, <span class="hljs-number">0</span>, page_size, mtr);
  inode = fsp_seg_inode_page_get_nth_inode(page, n, page_size, mtr);

  <span class="hljs-comment">// 如果由于本次分配导致该inode page内不再有可用的inode空间</span>
  <span class="hljs-comment">// 那需要将该inode page从space的FSP_SEG_INODES_FREE链表摘除并加入FSP_SEG_INODES_FULL链表尾部</span>
  <span class="hljs-keyword">if</span> (FIL_NULL == fsp_seg_inode_page_find_free(page, n + <span class="hljs-number">1</span>, page_size, mtr)) {
    flst_remove(space_header + FSP_SEG_INODES_FREE, page + FSEG_INODE_PAGE_NODE,
                mtr);
    flst_add_last(space_header + FSP_SEG_INODES_FULL,
                  page + FSEG_INODE_PAGE_NODE, mtr);
  }
  <span class="hljs-keyword">return</span> (inode);
}
</code></pre>

<p>优先从table space的FSP_SEG_INODES_FREE链表中获取inode page并从中分配未使用的inode。</p>

<p>如果FSP_SEG_INODES_FREE链表为空，说明当前已无空闲的inode page，此时需分配新的inode page，参考函数<em>fsp_alloc_seg_inode_page</em>：</p>

<pre><code class="language-c++ hljs cpp"><span class="hljs-comment">// 从space中分配一个未使用的inode page</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> ibool <span class="hljs-title">fsp_alloc_seg_inode_page</span><span class="hljs-params">(
    fsp_header_t *space_header,
    mtr_t *mtr)</span>
</span>{
  space = page_get_space_id(page_align(space_header));
  <span class="hljs-function"><span class="hljs-keyword">const</span> page_size_t <span class="hljs-title">page_size</span><span class="hljs-params">(mach_read_from_4(FSP_SPACE_FLAGS + space_header)</span>)</span>;

  <span class="hljs-comment">// fsp_alloc_free_page这个函数比较有意思,值得仔细研究一番</span>
  <span class="hljs-comment">// 分配一个空闲page作为inode page</span>
  block = fsp_alloc_free_page(space, page_size, <span class="hljs-number">0</span>, RW_SX_LATCH, mtr, mtr);
  page = buf_block_get_frame(block);
  <span class="hljs-comment">// 设置新分配的PAGE类型为FIL_PAGE_INODE</span>
  mlog_write_ulint(page + FIL_PAGE_TYPE, FIL_PAGE_INODE, MLOG_2BYTES, mtr);

  <span class="hljs-comment">// 初始化inode page中的所有inode信息为空闲</span>
  <span class="hljs-keyword">for</span> (page_no_t i = <span class="hljs-number">0</span>; i &lt; FSP_SEG_INODES_PER_PAGE(page_size); i++) {
    inode = fsp_seg_inode_page_get_nth_inode(page, i, page_size, mtr);
    mlog_write_ull(inode + FSEG_ID, <span class="hljs-number">0</span>, mtr);
  }
  <span class="hljs-comment">// 将新分配的inode page加入至FSP_SEG_INODES_FREE链表的尾部</span>
  flst_add_last(space_header + FSP_SEG_INODES_FREE, page + FSEG_INODE_PAGE_NODE, mtr);
  <span class="hljs-keyword">return</span> (TRUE);
}
</code></pre>

<h4>分配extent</h4>

<p><em>fsp_alloc_free_extent</em>被用来分配一个extent，即xdes，一般segment内无可用page时会向表空间申请分配空闲extent。</p>

<p>分配extent的核心是分配空闲xdes，因为根据xdes我们可以很迅速地定位extent。</p>

<pre><code class="language-c++ hljs cpp"><span class="hljs-comment">// 参数@hint给出一个线索:可以尝试先使用该page所在的extent,如果其状态为free的话</span>
<span class="hljs-comment">// hint表明调用者建议从该page开始分配空间以获得更好的连续性</span>
<span class="hljs-comment">// 该函数会优先分配该hint page所在的extent,如果其尚未被分配的话</span>
<span class="hljs-keyword">static</span> xdes_t *fsp_alloc_free_extent(space_id_t space_id,
                                     <span class="hljs-keyword">const</span> page_size_t &amp;page_size,
                                     page_no_t hint, mtr_t *mtr) {
  fsp_header_t *header;
  fil_addr_t first;
  xdes_t *descr;
  buf_block_t *desc_block = NULL;

  header = fsp_get_space_header(space_id, page_size, mtr);

  <span class="hljs-comment">// 计算hint page所在的extent的xdes对象位置</span>
  <span class="hljs-comment">// 这个函数会在下面仔细分析</span>
  descr = xdes_get_descriptor_with_space_hdr(header, space_id, hint, mtr, <span class="hljs-keyword">false</span>,
                                             &amp;desc_block);
  fil_space_t *space = fil_space_get(space_id);

  <span class="hljs-comment">// 该xdes状态是FREE，表明该extent未分配给其他人使用</span>
  <span class="hljs-keyword">if</span> (descr &amp;&amp; (xdes_get_state(descr, mtr) == XDES_FREE)) {
      <span class="hljs-comment">/* Ok, we can take this extent */</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 需要从table space header上的FSP_FREE链表中获取一个可分配的extent</span>
    first = flst_get_first(header + FSP_FREE, mtr);
    <span class="hljs-keyword">if</span> (fil_addr_is_null(first)) {
      <span class="hljs-comment">// 如果FSP_FREE链表为空,那么只能分配一个新的xdes了，其磁盘位置记录在first中(page, boff)</span>
      fsp_fill_free_list(<span class="hljs-keyword">false</span>, space, header, mtr);
      first = flst_get_first(header + FSP_FREE, mtr);
    }
    
    descr = xdes_lst_get_descriptor(space_id, page_size, first, mtr);
  }
  flst_remove(header + FSP_FREE, descr + XDES_FLST_NODE, mtr);
  space-&gt;free_len--;
  <span class="hljs-keyword">return</span> (descr);
}
</code></pre>

<p>该函数的调用者会给该函数一个提示hint，指示优先分配该hint page所在的extent，如果该extent是空闲状态（描述extent的xdes有state状态位），便分配该extent，否则需重新分配：</p>

<ol>
  <li>从table space的FSP_FREE链表上获取第一个可分配的xdes，将其从FSP_FREE链表摘除并直接返回即可。</li>
  <li>如果FSP_FREE链表为空，则需分配新的xdes了，调用函数<em>fsp_fill_free_list</em>。它用来分配extent并返回其相应的xdes。</li>
</ol>

<pre><code class="language-c++ hljs cpp"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">fsp_fill_free_list</span><span class="hljs-params">(<span class="hljs-keyword">bool</span> init_space, fil_space_t *space,
                               fsp_header_t *header, mtr_t *mtr)</span> </span>{
  page_no_t limit;
  page_no_t size;
  ulint flags;
  xdes_t *descr;
  ulint count = <span class="hljs-number">0</span>;
  page_no_t i;

  <span class="hljs-comment">// size代表table space当前的大小(可以理解为ibd文件的大小)</span>
  size = mach_read_from_4(header + FSP_SIZE);
  <span class="hljs-comment">// limit: 暂时还不理解</span>
  limit = mach_read_from_4(header + FSP_FREE_LIMIT);
  flags = mach_read_from_4(header + FSP_SPACE_FLAGS);

  <span class="hljs-function"><span class="hljs-keyword">const</span> page_size_t <span class="hljs-title">page_size</span><span class="hljs-params">(flags)</span></span>;

  <span class="hljs-comment">// 需要扩张ibd文件,调用fsp_try_extend_data_file</span>
  <span class="hljs-comment">// 扩张ibd文件逻辑在下面仔细研究</span>
  <span class="hljs-keyword">if</span> (size &lt; limit + FSP_EXTENT_SIZE * FSP_FREE_ADD) {
    <span class="hljs-keyword">if</span> ((!init_space &amp;&amp; !fsp_is_system_tablespace(space-&gt;id) &amp;&amp;
         !fsp_is_global_temporary(space-&gt;id)) ||
        (space-&gt;id == TRX_SYS_SPACE &amp;&amp;
         srv_sys_space.can_auto_extend_last_file()) ||
        (fsp_is_global_temporary(space-&gt;id) &amp;&amp;
         srv_tmp_space.can_auto_extend_last_file())) {
      fsp_try_extend_data_file(space, header, mtr);
      size = space-&gt;size_in_header;
    }
  }

  <span class="hljs-comment">// 文件成功扩张后,开始分配extent</span>
  <span class="hljs-comment">// limit到底是什么意思呢？</span>
  i = limit;

  <span class="hljs-comment">// 结束条件:</span>
  <span class="hljs-comment">// 1. 分配的extent未超过当前表空间物理文件大小(size)</span>
  <span class="hljs-comment">// 2. 分配的extent数量超过了FSP_FREE_ADD(4):这是因为程序中限制了每次填充extent的最大个数</span>
  <span class="hljs-keyword">while</span> ((init_space &amp;&amp; i &lt; <span class="hljs-number">1</span>) ||
         ((i + FSP_EXTENT_SIZE &lt;= size) &amp;&amp; (count &lt; FSP_FREE_ADD))) {
    <span class="hljs-comment">// 什么时候init_xdes为true呢? 还没思考明白</span>
    <span class="hljs-comment">// #define ut_2pow_remainder(n, m) ((n) &amp; ((m)-1))</span>
    <span class="hljs-keyword">bool</span> init_xdes = (ut_2pow_remainder(i, page_size.physical()) == <span class="hljs-number">0</span>);

    space-&gt;free_limit = i + FSP_EXTENT_SIZE;
    mlog_write_ulint(header + FSP_FREE_LIMIT, i + FSP_EXTENT_SIZE, MLOG_4BYTES, mtr);

    <span class="hljs-comment">// 需要初始化xdes page</span>
    <span class="hljs-keyword">if</span> (init_xdes) {
      ...
    }

    buf_block_t *desc_block = NULL;
    <span class="hljs-comment">// 根据上面分配的extent计算其对应的xdes所在的xdes page以及在page内的偏移</span>
    descr = xdes_get_descriptor_with_space_hdr(header, space-&gt;id, i, mtr,
                                               init_space, &amp;desc_block);
    xdes_init(descr, mtr);

    <span class="hljs-keyword">if</span> (init_xdes) {
      fsp_init_xdes_free_frag(header, descr, mtr);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 将刚创建的extent加入至fsp header的FSP_FREE链表尾部</span>
      flst_add_last(header + FSP_FREE, descr + XDES_FLST_NODE, mtr);
      count++;
    }

    i += FSP_EXTENT_SIZE;
  }
  space-&gt;free_len += (<span class="hljs-keyword">uint32_t</span>)count;
}
</code></pre>

<p>这个函数有几个比较有趣的地方：</p>

<ol>
  <li><em>fsp_try_extend_data_file</em>：尝试扩张table space文件，分配extent说到底需要底层物理存储空间</li>
  <li><em>init_xdes</em>的计算</li>
  <li><em>xdes_get_descriptor_with_space_hdr</em>：根据分配的extent计算其对应的xdes所在的page以及page内偏移</li>
</ol>

<p>我们接下来一一阐述。</p>

<p><em>fsp_try_extend_data_file</em>用于扩充ibd文件：</p>

<pre><code class="language-c++ hljs cpp"><span class="hljs-function"><span class="hljs-keyword">static</span> UNIV_COLD ulint <span class="hljs-title">fsp_try_extend_data_file</span><span class="hljs-params">(fil_space_t *space,
                                                fsp_header_t *header,
                                                mtr_t *mtr)</span>
</span>{
  page_no_t size;
  page_no_t size_increase;

  size = mach_read_from_4(header + FSP_SIZE);

  <span class="hljs-function"><span class="hljs-keyword">const</span> page_size_t <span class="hljs-title">page_size</span><span class="hljs-params">(mach_read_from_4(header + FSP_SPACE_FLAGS)</span>)</span>;

  <span class="hljs-keyword">if</span> (space-&gt;id == TRX_SYS_SPACE) {
      ...
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fsp_is_global_temporary(space-&gt;id)) {
	  ...
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 首先判断如果当前ibd文件大小小于extent_size(典型是1MB)</span>
    <span class="hljs-comment">// 首先将其extent至extent_size(典型是1MB)</span>
    page_no_t extent_pages = fsp_get_extent_size_in_pages(page_size);
    <span class="hljs-keyword">if</span> (size &lt; extent_pages) {
      <span class="hljs-comment">/* Let us first extend the file to extent_size */</span>
      <span class="hljs-keyword">if</span> (!fsp_try_extend_data_file_with_pages(space, extent_pages - <span class="hljs-number">1</span>, header,
                                               mtr)) {
      }
      size = extent_pages;
    }
    <span class="hljs-comment">// 接下来判断每次extent的幅度,其算法是:</span>
    <span class="hljs-comment">// 1. 如果当前ibd大小小于32个extent_size,每次extent单位为extent_size</span>
    <span class="hljs-comment">// 2. 否则,每次extent单位为FSP_FREE_ADD(4) * extent_size;</span>
    size_increase = fsp_get_pages_to_extend_ibd(page_size, size);
  }

  <span class="hljs-keyword">if</span> (!fil_space_extend(space, size + size_increase)) {
    DBUG_RETURN(<span class="hljs-keyword">false</span>);
  }

  <span class="hljs-comment">// 修改fsp header中的大小</span>
  space-&gt;size_in_header =
      ut_calc_align_down(space-&gt;size, (<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>) / page_size.physical());

  fsp_header_size_update(header, space-&gt;size_in_header, mtr);
}
</code></pre>

<p><em>xdes_get_descriptor_with_space_hdr</em>用来根据extent的起始page no计算该extent对应的xdes所在的page以及在page内的位置。</p>

<pre><code class="language-c++ hljs cpp"><span class="hljs-comment">// offset为extent的起始page no</span>
<span class="hljs-function">UNIV_INLINE <span class="hljs-title">MY_ATTRIBUTE</span><span class="hljs-params">((warn_unused_result)</span>) xdes_t
    *<span class="hljs-title">xdes_get_descriptor_with_space_hdr</span><span class="hljs-params">(fsp_header_t *sp_header,
                                        space_id_t space, page_no_t offset,
                                        mtr_t *mtr, <span class="hljs-keyword">bool</span> init_space = <span class="hljs-keyword">false</span>,
                                        buf_block_t **desc_block = NULL)</span> </span>{
  ulint limit;
  ulint size;
  page_no_t descr_page_no;
  ulint flags;
  page_t *descr_page;

  <span class="hljs-function"><span class="hljs-keyword">const</span> page_size_t <span class="hljs-title">page_size</span><span class="hljs-params">(flags)</span></span>;

  descr_page_no = xdes_calc_descriptor_page(page_size, offset);

  buf_block_t *block;

  <span class="hljs-keyword">if</span> (descr_page_no == <span class="hljs-number">0</span>) {
    <span class="hljs-comment">/* It is on the space header page */</span>
    descr_page = page_align(sp_header);
    block = NULL;
  } <span class="hljs-keyword">else</span> {
    block = buf_page_get(page_id_t(space, descr_page_no), page_size,
                         RW_SX_LATCH, mtr);
    descr_page = buf_block_get_frame(block);
  }

  <span class="hljs-keyword">if</span> (desc_block != NULL) {
    *desc_block = block;
  }

  <span class="hljs-keyword">return</span> (descr_page + XDES_ARR_OFFSET +
          XDES_SIZE * xdes_calc_descriptor_index(page_size, offset));
}
</code></pre>

<p>这个函数是根据extent的起始page no来计算其xdes所在的page以及page内偏移。从前文的描述中我们知道，每个extent对应了一个描述它的xdes，且xdes存储在XDES_PAGE之中（当然 root page中也会存储xdes），每个XDES_PAGE内可存储256个xdes结构，用来描述其后连续256个extent(1M)的情况，因此，一旦我们知道了某个extent的起始page no，便可以反推出其对应的xdes所在的page，<em>xdes_calc_descriptor_page</em>函数我们会在后面仔细描述。如下：</p>

<p><img src="./MySQL · 引擎特性 · Innodb 表空间_files/ibd_xdes_2_extent.png" alt=""></p>

<h4>分配page</h4>

<pre><code class="language-c++ hljs cpp"><span class="hljs-keyword">static</span> buf_block_t *fseg_alloc_free_page_low(fil_space_t *space,
                                             <span class="hljs-keyword">const</span> page_size_t &amp;page_size,
                                             fseg_inode_t *seg_inode,
                                             page_no_t hint, byte direction,
                                             rw_lock_type_t rw_latch,
                                             mtr_t *mtr, mtr_t *init_mtr
)
{
	...
}
</code></pre>

<p>在<em>fseg_alloc_free_page_low</em>函数中实现了7种情况从segment中分配page：</p>

<ol>
  <li>segment的hint位置的页是空闲状态，直接返回对应的page</li>
  <li>xdes是空闲状态，但segment中的空闲page数量小于总page数量的1/8且碎片页被全部用完，为其分配一个空闲extent，并直接分配hint对应的page</li>
  <li>如果xdes不是空闲状态，且segment inode中的空闲page数量 &lt; 1/8，在inode当中获得一个空闲的extent，并且将这个extent descr对应的页返回。</li>
  <li>descr是XDES_FSEG状态，且这个extent中还有空闲page,从其中获取一个page.</li>
  <li>除了以上情况外，如果descr不是空闲的，但是inode还有其他的空闲extent,从其他的extent获得一个空闲</li>
  <li>如果其他的extent没有空闲页，但是fragment array还有空闲的碎片page，从空闲的碎片page中获得一个空闲页。</li>
  <li>如果连碎页也没有，直接申请分配一个新的extent，并在其中获取一个空闲的page.</li>
</ol>

<h4>关键辅助对象和函数</h4>

<p><strong>磁盘链表</strong></p>

<p>Innodb的磁盘链表主要是用来连接存储在磁盘上的对象。链表每项并非基于内存指针的，而是基于对象在磁盘中的位置(page no + offset)来描述。</p>

<pre><code class="language-c++ hljs cpp"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> fil_addr_struct
{
  ulint page;    <span class="hljs-comment">/*page在space中的编号*/</span>
  ulint boffset; <span class="hljs-comment">/*page中的字节偏移量，在内存中使用2字节表示*/</span>
} fil_addr_t;

<span class="hljs-keyword">typedef</span> byte flst_node_t;
<span class="hljs-keyword">typedef</span> byte flst_base_node_t;
<span class="hljs-comment">/* The physical size of a list base node in bytes */</span>
<span class="hljs-keyword">constexpr</span> ulint FLST_BASE_NODE_SIZE = <span class="hljs-number">4</span> + <span class="hljs-number">2</span> * FIL_ADDR_SIZE;
<span class="hljs-comment">/* The physical size of a list node in bytes */</span>
<span class="hljs-keyword">constexpr</span> ulint FLST_NODE_SIZE = <span class="hljs-number">2</span> * FIL_ADDR_SIZE;
</code></pre>

<p><em>flst_node_t</em>代表链表上的一个节点，其大小为12字节，其中前6字节（page:4 boffset:2）表示链表中前一个节点的fil_addr_t信息，后6个字节表示链表中下一个节点的fil_addr_t信息。</p>

<p><em>flst_base_node_t</em>则用于描述链表的整体信息，包括：</p>

<blockquote>
  <p>链表节点个数FLST_LEN（4字节）</p>

  <p>链表首节点的fil_addr_t (6字节)</p>

  <p>链表尾节点的fil_addr_t（6字节）</p>
</blockquote>

<p>每个磁盘空间链表的结构如下所示：</p>

<p><img src="./MySQL · 引擎特性 · Innodb 表空间_files/ibd_disk_object_list.png" alt=""></p>

<p>Innodb 表空间的fsp header page中定义了多种链表，这在前面已经作过描述，不再赘述。这些链表在fsp header_init时被初始化，初始时链表为空：</p>

<pre><code class="language-c++ hljs cpp"><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">fsp_header_init</span><span class="hljs-params">(space_id_t space_id, page_no_t size, mtr_t *mtr,
                     <span class="hljs-keyword">bool</span> is_boot)</span> 
</span>{
  flst_init(header + FSP_FREE, mtr);
  flst_init(header + FSP_FREE_FRAG, mtr);
  flst_init(header + FSP_FULL_FRAG, mtr);
  flst_init(header + FSP_SEG_INODES_FULL, mtr);
  flst_init(header + FSP_SEG_INODES_FREE, mtr);
}

<span class="hljs-function">UNIV_INLINE
<span class="hljs-keyword">void</span> <span class="hljs-title">flst_init</span><span class="hljs-params">(flst_base_node_t *base, mtr_t *mtr)</span>          
</span>{
  mlog_write_ulint(base + FLST_LEN, <span class="hljs-number">0</span>, MLOG_4BYTES, mtr);
  flst_write_addr(base + FLST_FIRST, fil_addr_null, mtr);
  flst_write_addr(base + FLST_LAST, fil_addr_null, mtr);
}

buf_block_t *fseg_create_general(
    space_id_t space_id, 
    page_no_t page,
    ulint byte_offset,
    ibool has_done_reservation,
    mtr_t *mtr)
{
  ...
  flst_init(inode + FSEG_FREE, mtr);
  flst_init(inode + FSEG_NOT_FULL, mtr);
  flst_init(inode + FSEG_FULL, mtr);
  ...
}
</code></pre>

<p>每个要连接在该链表上的对象中均需要预留12个字节来记录前后节点位置。例如，xdes和inode page中均有该12字节的预留。</p>

<p><img src="./MySQL · 引擎特性 · Innodb 表空间_files/ibd_xdes.png" alt=""></p>

<p><img src="./MySQL · 引擎特性 · Innodb 表空间_files/ibd_inode_page.png" alt=""></p>

<p><strong>xdes_calc_descriptor_page</strong></p>

<p>该函数根据page no计算描述其所在的extent的xdes对象位置（即xdes所在的page no）。</p>

<pre><code class="language-c++ hljs cpp"><span class="hljs-comment">// 以m为16384为例，如果n &lt; 16384，计算的结果是0</span>
<span class="hljs-comment">// 如果16384 =&lt; n &lt; 32768,计算的结果是16384</span>
<span class="hljs-comment">// 如果32768 =&lt; n &lt; 49152,计算的结果是32768</span>
<span class="hljs-comment">// 以此类推</span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">define</span> ut_2pow_round(n, m) ((n) &amp; ~((m)-1))</span>

<span class="hljs-function">UNIV_INLINE
page_no_t <span class="hljs-title">xdes_calc_descriptor_page</span><span class="hljs-params">(<span class="hljs-keyword">const</span> page_size_t &amp;page_size,
                                    page_no_t offset)</span> 
</span>{
      <span class="hljs-keyword">return</span> (ut_2pow_round(offset, page_size.physical()));
}
</code></pre>

<p>根据我们上面的知识储备，每个xdes page管理随后的连续256个extent的空间（假如page size为16KB的话，那总大小就是256MB）。假如每个page是16KB，256MB包含的页面数是256MB/16KB = 16384，因此，所有page no小于16384的page其xdes都会位于第0个page（root page），而page no介于16384~32768的page其xdes page便是page 16384，与<em>xdes_calc_descriptor_page</em>计算是吻合的。</p>

<h4>参考</h4>

<ul>
  <li><a href="https://blog.jcole.us/2013/01/04/page-management-in-innodb-space-files/" target="_blank">https://blog.jcole.us/2013/01/04/page-management-in-innodb-space-files/</a></li>
  <li><a href="http://www.leviathan.vip/2019/04/18/InnoDB%E7%9A%84%E6%96%87%E4%BB%B6%E7%BB%84%E7%BB%87%E7%BB%93%E6%9E%84/" target="_blank">http://www.leviathan.vip/2019/04/18/InnoDB%E7%9A%84%E6%96%87%E4%BB%B6%E7%BB%84%E7%BB%87%E7%BB%93%E6%9E%84/</a></li>
  <li><a href="https://colinback.github.io/szyblogs/database/2018/05/10/innodb-kernel-5/" target="_blank">https://colinback.github.io/szyblogs/database/2018/05/10/innodb-kernel-5/</a></li>
  <li><a href="http://mysql.taobao.org/monthly/2016/02/01/" target="_blank">http://mysql.taobao.org/monthly/2016/02/01/</a></li>
  <li><a href="https://www.jianshu.com/p/55d861c59bc3" target="_blank">https://www.jianshu.com/p/55d861c59bc3</a></li>
</ul>

    </section>
  </div>
</div>


    <footer>
  <script src="./MySQL · 引擎特性 · Innodb 表空间_files/av-mini-0.6.10.js"></script>
  <script src="./MySQL · 引擎特性 · Innodb 表空间_files/hit-kounter-lc-0.2.0.js"></script>
  <a href="http://mysql.taobao.org/" target="_blank" class="muted">阿里云RDS-数据库内核组</a>
  <br>
  <a href="https://github.com/alibaba/AliSQL" target="_blank" class="muted">欢迎在github上star AliSQL</a>
  <br>
  阅读：<span data-hk-page="current"> - </span><span class="pause">  </span>
<br>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/" target="_blank"><img alt="知识共享许可协议" style="border-width:0" src="./MySQL · 引擎特性 · Innodb 表空间_files/88x31.png"></a><br>本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/" target="_blank">知识共享署名-非商业性使用-相同方式共享 3.0 未本地化版本许可协议</a>进行许可。
</footer>

<script type="text/javascript">
  jQuery(document).ready(function($){
    // browser window scroll (in pixels) after which the "back to top" link is shown
    var offset = 300,
      //browser window scroll (in pixels) after which the "back to top" link opacity is reduced
      offset_opacity = 1200,
      //duration of the top scrolling animation (in ms)
      scroll_top_duration = 700,
      //grab the "back to top" link
      $back_to_top = $('.cd-top');

    //hide or show the "back to top" link
    $(window).scroll(function(){
      ( $(this).scrollTop() > offset ) ? $back_to_top.addClass('cd-is-visible') : $back_to_top.removeClass('cd-is-visible cd-fade-out');
      if( $(this).scrollTop() > offset_opacity ) {
        $back_to_top.addClass('cd-fade-out');
      }
    });

    //smooth scroll to top
    $back_to_top.on('click', function(event){
      event.preventDefault();
      $('body,html').animate({
        scrollTop: 0 ,
        }, scroll_top_duration
      );
    });

  });
</script>



    <a href="http://mysql.taobao.org/monthly/2019/10/01/#0" class="cd-top"><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="10px" width="38px" height="60px" viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
      <polygon fill="#FFFFFF" points="8,2.8 16,10.7 13.6,13.1 8.1,7.6 2.5,13.2 0,10.7 "></polygon>
    </svg>
    </a>
  


</body></html>